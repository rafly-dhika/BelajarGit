<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi SPK Kredit - CIMB Niaga</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Styles for Print & Transitions */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Print Styling */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white; }
            #main-content { margin: 0; padding: 0; width: 100%; }
        }

        /* Utility */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #B91C1C; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #991B1B; }
    </style>
</head>
<body class="text-gray-800">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-90">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md glass-panel">
            <div class="text-center mb-6">
                <!-- Branding CIMB Niaga (Merah) -->
                <i class="fas fa-university text-5xl text-red-700 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800">SPK Kredit AHP</h2>
                <p class="text-gray-500 text-sm">CIMB Niaga Credit System</p>
            </div>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                    <input type="text" id="username" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Username" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Password" required>
                </div>
                <button type="submit" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-200">
                    Masuk
                </button>
                <!-- Keterangan login tetap ada agar Anda tidak lupa passwordnya -->
                <p class="mt-4 text-xs text-center text-gray-500"> <b></b>  <b></b></p>
            </form>
        </div>
    </div>

    <!-- MAIN APP LAYOUT (Hidden initially) -->
    <div id="app-layout" class="hidden flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-900 text-white flex flex-col no-print transition-all duration-300" id="sidebar">
            <!-- Header Sidebar CIMB -->
            <div class="h-16 flex items-center justify-center border-b border-gray-700 bg-red-800">
                <h1 class="text-xl font-bold tracking-wider"><i class="fas fa-university mr-2"></i>CIMB Niaga</h1>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-2 px-2">
                    <li><button onclick="navigate('dashboard')" class="nav-item w-full text-left px-4 py-2 rounded hover:bg-gray-800 flex items-center bg-gray-800 border-l-4 border-red-600"><i class="fas fa-home w-8"></i> Dashboard</button></li>
                    <li><button onclick="navigate('nasabah')" class="nav-item w-full text-left px-4 py-2 rounded hover:bg-gray-800 flex items-center"><i class="fas fa-users w-8"></i> Data Nasabah</button></li>
                    <li><button onclick="navigate('ahp')" class="nav-item w-full text-left px-4 py-2 rounded hover:bg-gray-800 flex items-center"><i class="fas fa-balance-scale w-8"></i> Analisis AHP</button></li>
                    <li><button onclick="navigate('penilaian')" class="nav-item w-full text-left px-4 py-2 rounded hover:bg-gray-800 flex items-center"><i class="fas fa-calculator w-8"></i> Penilaian & Skor</button></li>
                    <li><button onclick="navigate('laporan')" class="nav-item w-full text-left px-4 py-2 rounded hover:bg-gray-800 flex items-center"><i class="fas fa-file-alt w-8"></i> Laporan</button></li>
                </ul>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded text-sm"><i class="fas fa-sign-out-alt mr-1"></i> Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden bg-gray-100 relative">
            <!-- Header -->
            <header class="h-16 bg-white shadow flex items-center justify-between px-6 no-print">
                <div class="flex items-center">
                    <button id="toggleSidebar" class="text-gray-500 focus:outline-none lg:hidden mr-4">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 id="page-title" class="text-xl font-semibold text-gray-800">Dashboard</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <p class="text-sm font-semibold text-gray-700">Admin</p>
                        <p class="text-xs text-gray-500">Credit Analyst</p>
                    </div>
                    <!-- Avatar Merah -->
                    <div class="h-10 w-10 rounded-full bg-red-700 flex items-center justify-center text-white font-bold shadow-lg">
                        CN
                    </div>
                </div>
            </header>

            <!-- Scrollable Content Area -->
            <div id="content-area" class="flex-1 overflow-x-hidden overflow-y-auto p-6 scroll-smooth">
                
                <!-- 1. DASHBOARD VIEW -->
                <div id="view-dashboard" class="fade-in space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white rounded-lg shadow p-5 border-l-4 border-red-700">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm uppercase">Total Nasabah</p>
                                    <h3 class="text-2xl font-bold" id="dash-total-nasabah">0</h3>
                                </div>
                                <div class="bg-red-100 p-3 rounded-full text-red-700"><i class="fas fa-users"></i></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5 border-l-4 border-green-600">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm uppercase">Layak Kredit</p>
                                    <h3 class="text-2xl font-bold" id="dash-layak">0</h3>
                                </div>
                                <div class="bg-green-100 p-3 rounded-full text-green-600"><i class="fas fa-check-circle"></i></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5 border-l-4 border-red-400">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm uppercase">Ditolak</p>
                                    <h3 class="text-2xl font-bold" id="dash-tolak">0</h3>
                                </div>
                                <div class="bg-red-50 p-3 rounded-full text-red-400"><i class="fas fa-times-circle"></i></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5 border-l-4 border-yellow-500">
                            <div class="flex justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm uppercase">Avg Limit (IDR)</p>
                                    <h3 class="text-xl font-bold" id="dash-avg-limit">0</h3>
                                </div>
                                <div class="bg-yellow-100 p-3 rounded-full text-yellow-600"><i class="fas fa-wallet"></i></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-bold mb-4">Distribusi Kelayakan</h3>
                            <div class="relative h-64">
                                <canvas id="chartStatus"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-bold mb-4">Bobot Kriteria AHP</h3>
                            <div class="relative h-64">
                                <canvas id="chartAhp"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. DATA NASABAH VIEW -->
                <div id="view-nasabah" class="hidden fade-in">
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-bold">Daftar Nasabah</h3>
                            <!-- Tombol Merah -->
                            <button onclick="openModalNasabah()" class="bg-red-700 text-white px-4 py-2 rounded hover:bg-red-800 text-sm shadow">
                                <i class="fas fa-plus mr-1"></i> Tambah Nasabah
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full whitespace-nowrap">
                                <thead class="bg-gray-50 text-gray-600 font-semibold text-xs uppercase tracking-wider text-left">
                                    <tr>
                                        <th class="p-4">ID</th>
                                        <th class="p-4">Nama</th>
                                        <th class="p-4">NIK</th>
                                        <th class="p-4">Pekerjaan</th>
                                        <th class="p-4">Penghasilan (Bulan)</th>
                                        <th class="p-4 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="table-nasabah-body" class="text-sm divide-y divide-gray-200">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. AHP ANALYSIS VIEW -->
                <div id="view-ahp" class="hidden fade-in space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold mb-4 text-red-800">1. Kriteria & Pembobotan (Pairwise Comparison)</h3>
                        <p class="text-sm text-gray-600 mb-4">Bandingkan tingkat kepentingan antar kriteria untuk mendapatkan bobot prioritas.</p>
                        
                        <div class="overflow-x-auto mb-6">
                            <table class="w-full border text-sm text-center">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2 border">Kriteria A</th>
                                        <th class="p-2 border">Nilai Banding (1-9)</th>
                                        <th class="p-2 border">Kriteria B</th>
                                    </tr>
                                </thead>
                                <tbody id="ahp-comparison-body">
                                    <!-- Dynamic Inputs -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Tombol Hitung Merah -->
                        <button onclick="calculateAHP()" class="w-full bg-red-800 text-white py-2 rounded hover:bg-red-900 mb-6 shadow">
                            Hitung Bobot & Konsistensi
                        </button>

                        <div id="ahp-result" class="hidden border-t pt-4">
                            <h4 class="font-bold text-md mb-2">Hasil Perhitungan AHP:</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm">Konsistensi Index (CI): <span id="val-ci" class="font-mono"></span></p>
                                    <p class="text-sm">Konsistensi Ratio (CR): <span id="val-cr" class="font-mono font-bold"></span></p>
                                    <div id="cr-status" class="mt-2 text-xs px-2 py-1 rounded inline-block"></div>
                                </div>
                                <div>
                                    <table class="w-full text-xs border">
                                        <thead><tr class="bg-gray-100"><th class="p-1">Kriteria</th><th class="p-1">Bobot</th></tr></thead>
                                        <tbody id="ahp-weights-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. PENILAIAN & SCORING VIEW -->
                <div id="view-penilaian" class="hidden fade-in space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold">Penilaian Nasabah</h3>
                            <button onclick="runScoring()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 shadow">
                                <i class="fas fa-play mr-1"></i> Hitung Skor & Keputusan
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">Masukkan nilai (1-100) untuk setiap kriteria per nasabah. Sistem akan mengalikan dengan bobot AHP.</p>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left border-collapse">
                                <thead class="bg-gray-100">
                                    <tr id="scoring-header-row">
                                        <th class="p-3 border">Nasabah</th>
                                        <!-- Criteria headers injected here -->
                                    </tr>
                                </thead>
                                <tbody id="scoring-body">
                                    <!-- Scoring inputs injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="result-section" class="hidden bg-white p-6 rounded-lg shadow border-t-4 border-green-500">
                        <h3 class="text-lg font-bold mb-4">Hasil Keputusan & Limit Kredit</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="p-3">Nasabah</th>
                                        <th class="p-3">Skor AHP</th>
                                        <th class="p-3">Status</th>
                                        <th class="p-3">Max Installment (30%)</th>
                                        <th class="p-3">Rekomendasi Limit</th>
                                    </tr>
                                </thead>
                                <tbody id="result-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 5. LAPORAN VIEW -->
                <div id="view-laporan" class="hidden fade-in">
                    <div class="bg-white p-8 rounded-lg shadow mb-6 print-area">
                        <div class="flex justify-between items-start mb-8 border-b pb-4">
                            <div>
                                <h2 class="text-2xl font-bold uppercase tracking-wide text-red-800">Laporan Keputusan Kredit</h2>
                                <p class="text-gray-500 text-sm">CIMB Niaga Credit Analysis Report</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-bold">Tanggal:</p>
                                <p class="text-sm text-gray-600" id="report-date"></p>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="font-bold text-gray-700 mb-2">Ringkasan Statistik</h4>
                            <div class="grid grid-cols-3 gap-4 text-center text-sm">
                                <div class="bg-gray-50 p-2 border">Total Pengajuan: <span id="rep-total" class="font-bold"></span></div>
                                <div class="bg-green-50 p-2 border text-green-800">Disetujui: <span id="rep-acc" class="font-bold"></span></div>
                                <div class="bg-red-50 p-2 border text-red-800">Ditolak: <span id="rep-rej" class="font-bold"></span></div>
                            </div>
                        </div>

                        <table class="w-full text-sm border-collapse border border-gray-300 mb-6">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border p-2">Nama Nasabah</th>
                                    <th class="border p-2">NIK</th>
                                    <th class="border p-2">Nilai Akhir</th>
                                    <th class="border p-2">Keputusan</th>
                                    <th class="border p-2">Limit Kredit (IDR)</th>
                                </tr>
                            </thead>
                            <tbody id="report-table-body">
                                <!-- Data -->
                            </tbody>
                        </table>

                        <div class="flex justify-between mt-12 text-center text-sm no-print">
                            <button onclick="window.print()" class="bg-gray-800 text-white px-6 py-2 rounded hover:bg-gray-900 shadow">
                                <i class="fas fa-print mr-2"></i> Cetak Laporan / Simpan PDF
                            </button>
                        </div>
                        
                        <!-- Signature Section for Print -->
                        <div class="print-only mt-16 flex justify-end">
                            <div class="text-center w-64">
                                <p class="mb-16">Mengetahui, <br> Head of Credit Risk</p>
                                <p class="font-bold border-t border-black pt-2">Rafly Andhika Raswan, S.Kom.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL ADD NASABAH -->
    <div id="modal-nasabah" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-bold">Tambah Nasabah Baru</h3>
                <button onclick="closeModalNasabah()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
            </div>
            <form id="form-nasabah" onsubmit="saveNasabah(event)" class="p-6 space-y-4">
                <input type="hidden" id="nasabah-id">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Nama Lengkap</label>
                        <input type="text" id="input-nama" class="w-full border rounded p-2 text-sm focus:border-red-500 focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">NIK</label>
                        <input type="text" id="input-nik" class="w-full border rounded p-2 text-sm focus:border-red-500 focus:outline-none" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Pekerjaan</label>
                        <input type="text" id="input-job" class="w-full border rounded p-2 text-sm focus:border-red-500 focus:outline-none" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Penghasilan (Bulan)</label>
                        <input type="number" id="input-income" class="w-full border rounded p-2 text-sm focus:border-red-500 focus:outline-none" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">Aset & Kewajiban (Keterangan)</label>
                    <textarea id="input-desc" class="w-full border rounded p-2 text-sm focus:border-red-500 focus:outline-none" rows="2"></textarea>
                </div>
                <div class="flex justify-end space-x-2 pt-4 border-t">
                    <button type="button" onclick="closeModalNasabah()" class="px-4 py-2 bg-gray-200 rounded text-gray-700 text-sm">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-red-700 rounded text-white text-sm hover:bg-red-800 shadow">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- 1. STATE MANAGEMENT ---
        const criteria = [
            { id: 'c1', name: 'Penghasilan' },
            { id: 'c2', name: 'Jaminan' },
            { id: 'c3', name: 'Riwayat Kredit' },
            { id: 'c4', name: 'Pekerjaan' },
            { id: 'c5', name: 'Usia' }
        ];

        let state = {
            isLoggedIn: false,
            customers: [],
            ahpWeights: {}, // { c1: 0.4, c2: 0.2 ... }
            ahpCR: 0,
            decisions: []
        };

        // Initialize Data (Mock)
        function initData() {
            // Default Weights (Example)
            state.ahpWeights = { 'c1': 0.35, 'c2': 0.25, 'c3': 0.20, 'c4': 0.10, 'c5': 0.10 };
            
            // Dummy Customers
            state.customers = [
                { id: 1, nama: 'Andi Pratama', nik: '3201001', job: 'PNS', income: 8000000, scores: { c1: 80, c2: 70, c3: 90, c4: 100, c5: 80 } },
                { id: 2, nama: 'Budi Santoso', nik: '3201002', job: 'Wiraswasta', income: 15000000, scores: { c1: 95, c2: 60, c3: 50, c4: 80, c5: 70 } },
                { id: 3, nama: 'Citra Dewi', nik: '3201003', job: 'Karyawan Swasta', income: 5000000, scores: { c1: 60, c2: 50, c3: 85, c4: 70, c5: 90 } }
            ];
            
            addLog("System initialized with dummy data.");
            updateDashboard();
        }

        // --- 2. AUTHENTICATION ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(u === 'admin' && p === 'admin') {
                state.isLoggedIn = true;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-layout').classList.remove('hidden');
                addLog("User 'admin' logged in to CIMB Niaga System.");
                initData();
                renderNav();
                navigate('dashboard');
            } else {
                alert('Login Gagal! Gunakan admin/admin');
            }
        }

        function logout() {
            location.reload();
        }

        // --- 3. NAVIGATION ---
        function navigate(viewId) {
            // Hide all views
            ['dashboard', 'nasabah', 'ahp', 'penilaian', 'laporan'].forEach(id => {
                document.getElementById('view-' + id).classList.add('hidden');
            });
            // Show selected view
            const selectedView = document.getElementById('view-' + viewId);
            if(selectedView) {
                selectedView.classList.remove('hidden');
            }
            
            // Update UI State for Sidebar Active Item
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-gray-800', 'border-l-4', 'border-red-600');
            });
            
            // Trigger specific renders
            if(viewId === 'dashboard') updateDashboard();
            if(viewId === 'nasabah') renderNasabahTable();
            if(viewId === 'ahp') renderAHPInput();
            if(viewId === 'penilaian') renderScoringTable();
            if(viewId === 'laporan') renderReport();
            
            document.getElementById('page-title').innerText = viewId.charAt(0).toUpperCase() + viewId.slice(1);
        }

        function renderNav() {
            // Helper for active state - handled in navigate()
        }

        // --- 4. DATA NASABAH LOGIC ---
        function renderNasabahTable() {
            const tbody = document.getElementById('table-nasabah-body');
            tbody.innerHTML = '';
            state.customers.forEach((c, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-4 border-b text-gray-500">#${index+1}</td>
                    <td class="p-4 border-b font-bold">${c.nama}</td>
                    <td class="p-4 border-b">${c.nik}</td>
                    <td class="p-4 border-b">${c.job}</td>
                    <td class="p-4 border-b text-green-600 font-mono">Rp ${c.income.toLocaleString('id-ID')}</td>
                    <td class="p-4 border-b text-center">
                        <button onclick="deleteNasabah(${c.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function openModalNasabah() {
            document.getElementById('form-nasabah').reset();
            document.getElementById('modal-nasabah').classList.remove('hidden');
        }

        function closeModalNasabah() {
            document.getElementById('modal-nasabah').classList.add('hidden');
        }

        function saveNasabah(e) {
            e.preventDefault();
            const newCust = {
                id: Date.now(),
                nama: document.getElementById('input-nama').value,
                nik: document.getElementById('input-nik').value,
                job: document.getElementById('input-job').value,
                income: parseInt(document.getElementById('input-income').value),
                scores: { c1:0, c2:0, c3:0, c4:0, c5:0 } // Init scores
            };
            state.customers.push(newCust);
            addLog(`New nasabah added: ${newCust.nama}`);
            closeModalNasabah();
            renderNasabahTable();
        }

        function deleteNasabah(id) {
            if(confirm('Hapus data nasabah ini?')) {
                state.customers = state.customers.filter(c => c.id !== id);
                addLog(`Nasabah ID ${id} deleted.`);
                renderNasabahTable();
            }
        }

        // --- 5. AHP ENGINE ---
        function renderAHPInput() {
            const tbody = document.getElementById('ahp-comparison-body');
            tbody.innerHTML = '';
            // Generate pairwise combinations
            for(let i=0; i<criteria.length; i++) {
                for(let j=i+1; j<criteria.length; j++) {
                    const cA = criteria[i];
                    const cB = criteria[j];
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-2 border font-semibold">${cA.name}</td>
                        <td class="p-2 border">
                            <select class="ahp-pair border rounded p-1 w-full text-center bg-white" data-row="${i}" data-col="${j}">
                                <option value="9">9 - ${cA.name} Mutlak Lebih Penting</option>
                                <option value="7">7 - ${cA.name} Sangat Penting</option>
                                <option value="5">5 - ${cA.name} Lebih Penting</option>
                                <option value="3">3 - ${cA.name} Sedikit Lebih Penting</option>
                                <option value="1" selected>1 - Sama Penting</option>
                                <option value="0.333">1/3 - ${cB.name} Sedikit Lebih Penting</option>
                                <option value="0.2">1/5 - ${cB.name} Lebih Penting</option>
                                <option value="0.142">1/7 - ${cB.name} Sangat Penting</option>
                                <option value="0.111">1/9 - ${cB.name} Mutlak Lebih Penting</option>
                            </select>
                        </td>
                        <td class="p-2 border font-semibold">${cB.name}</td>
                    `;
                    tbody.appendChild(tr);
                }
            }
            renderAHPResultsTable();
        }

        function calculateAHP() {
            const size = criteria.length;
            let matrix = Array(size).fill().map(() => Array(size).fill(1));
            
            // Fill matrix from selects
            document.querySelectorAll('.ahp-pair').forEach(sel => {
                const r = parseInt(sel.getAttribute('data-row'));
                const c = parseInt(sel.getAttribute('data-col'));
                const val = parseFloat(sel.value);
                matrix[r][c] = val;
                matrix[c][r] = 1 / val;
            });

            // 1. Column Sums
            let colSums = Array(size).fill(0);
            for(let j=0; j<size; j++) {
                for(let i=0; i<size; i++) {
                    colSums[j] += matrix[i][j];
                }
            }

            // 2. Normalization & Weight Vector
            let weights = Array(size).fill(0);
            for(let i=0; i<size; i++) {
                let rowSum = 0;
                for(let j=0; j<size; j++) {
                    rowSum += matrix[i][j] / colSums[j];
                }
                weights[i] = rowSum / size;
            }

            // 3. Consistency (Lambda Max)
            let lambdaMax = 0;
            for(let j=0; j<size; j++) {
                lambdaMax += colSums[j] * weights[j];
            }

            const CI = (lambdaMax - size) / (size - 1);
            // Random Index for n=1 to 10
            const RI_Table = [0, 0, 0.58, 0.90, 1.12, 1.24, 1.32, 1.41, 1.45, 1.49];
            const RI = RI_Table[size] || 1.49;
            const CR = CI / RI;

            // Update State
            state.ahpCR = CR;
            criteria.forEach((c, i) => {
                state.ahpWeights[c.id] = weights[i];
            });

            // Display
            document.getElementById('ahp-result').classList.remove('hidden');
            document.getElementById('val-ci').innerText = CI.toFixed(4);
            const crEl = document.getElementById('val-cr');
            const stEl = document.getElementById('cr-status');
            
            crEl.innerText = CR.toFixed(4);
            if(CR <= 0.1) {
                stEl.innerText = "KONSISTEN (Valid)";
                stEl.className = "mt-2 text-xs px-2 py-1 rounded inline-block bg-green-100 text-green-800 border border-green-300";
            } else {
                stEl.innerText = "TIDAK KONSISTEN (>0.1)";
                stEl.className = "mt-2 text-xs px-2 py-1 rounded inline-block bg-red-100 text-red-800 border border-red-300";
            }

            addLog(`AHP Recalculated. CR: ${CR.toFixed(4)}`);
            renderAHPResultsTable();
        }

        function renderAHPResultsTable() {
            const tbody = document.getElementById('ahp-weights-body');
            tbody.innerHTML = '';
            criteria.forEach(c => {
                const tr = document.createElement('tr');
                const weight = state.ahpWeights[c.id] || 0;
                tr.innerHTML = `<td class="p-1 border">${c.name}</td><td class="p-1 border text-right font-mono">${(weight*100).toFixed(2)}%</td>`;
                tbody.appendChild(tr);
            });
        }

        // --- 6. SCORING & LIMIT ---
        function renderScoringTable() {
            const headerRow = document.getElementById('scoring-header-row');
            // Reset headers (keep first th)
            headerRow.innerHTML = '<th class="p-3 border bg-gray-200">Nasabah</th>';
            criteria.forEach(c => {
                headerRow.innerHTML += `<th class="p-3 border text-xs">${c.name} (${(state.ahpWeights[c.id]*100).toFixed(0)}%)</th>`;
            });

            const tbody = document.getElementById('scoring-body');
            tbody.innerHTML = '';
            
            state.customers.forEach(cust => {
                let rowHtml = `<td class="p-3 border font-semibold border-b">${cust.nama}</td>`;
                criteria.forEach(c => {
                    rowHtml += `
                        <td class="p-2 border text-center">
                            <input type="number" min="0" max="100" 
                                class="w-16 border rounded text-center score-input focus:border-red-500 focus:outline-none" 
                                data-id="${cust.id}" data-crit="${c.id}" 
                                value="${cust.scores[c.id] || 0}">
                        </td>
                    `;
                });
                const tr = document.createElement('tr');
                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });
        }

        function runScoring() {
            // Save inputs to state
            document.querySelectorAll('.score-input').forEach(inp => {
                const cid = parseInt(inp.getAttribute('data-id'));
                const crit = inp.getAttribute('data-crit');
                const cust = state.customers.find(c => c.id === cid);
                if(cust) cust.scores[crit] = parseInt(inp.value);
            });

            // Calculate Decisions
            state.decisions = state.customers.map(cust => {
                let totalScore = 0;
                criteria.forEach(c => {
                    const w = state.ahpWeights[c.id] || 0;
                    const s = cust.scores[c.id] || 0;
                    totalScore += (s * w); // Simple weighted sum
                });

                // Limit Calculation (Logic: 30% of Income * AHP Factor)
                const baseInstallment = cust.income * 0.3; 
                let limitFactor = 0;
                let status = "TIDAK LAYAK";

                if (totalScore >= 75) {
                    status = "SANGAT LAYAK";
                    limitFactor = 30; // 30x monthly installment (~2.5 years)
                } else if (totalScore >= 60) {
                    status = "LAYAK";
                    limitFactor = 12; // 12x monthly installment (1 year)
                } else {
                    limitFactor = 0;
                }

                const recLimit = baseInstallment * limitFactor;

                return {
                    ...cust,
                    finalScore: totalScore,
                    status: status,
                    limit: recLimit,
                    installment: baseInstallment
                };
            });

            // Sort by Rank
            state.decisions.sort((a,b) => b.finalScore - a.finalScore);

            // Render Result
            const tbody = document.getElementById('result-body');
            tbody.innerHTML = '';
            state.decisions.forEach(d => {
                const color = d.status.includes('TIDAK') ? 'text-red-600' : 'text-green-600';
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3">${d.nama}</td>
                        <td class="p-3 font-bold">${d.finalScore.toFixed(2)}</td>
                        <td class="p-3 font-bold ${color}">${d.status}</td>
                        <td class="p-3 text-gray-500 text-xs">Rp ${(d.installment).toLocaleString('id-ID')}</td>
                        <td class="p-3 font-mono font-bold">Rp ${(d.limit).toLocaleString('id-ID')}</td>
                    </tr>
                `;
            });

            document.getElementById('result-section').classList.remove('hidden');
            addLog("Scoring calculation performed.");
        }

        // --- 7. REPORTING ---
        function renderReport() {
            document.getElementById('report-date').innerText = new Date().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
            
            // Recalculate if decisions empty
            if(state.decisions.length === 0) runScoring();

            const tbody = document.getElementById('report-table-body');
            tbody.innerHTML = '';
            
            let accepted = 0;
            let rejected = 0;

            state.decisions.forEach(d => {
                if(d.status.includes('TIDAK')) rejected++; else accepted++;
                tbody.innerHTML += `
                    <tr>
                        <td class="border p-2">${d.nama}</td>
                        <td class="border p-2 text-center">${d.nik}</td>
                        <td class="border p-2 text-center">${d.finalScore.toFixed(2)}</td>
                        <td class="border p-2 text-center font-bold ${d.status.includes('TIDAK') ? 'text-red-600':'text-green-600'}">${d.status}</td>
                        <td class="border p-2 text-right">Rp ${d.limit.toLocaleString('id-ID')}</td>
                    </tr>
                `;
            });

            document.getElementById('rep-total').innerText = state.decisions.length;
            document.getElementById('rep-acc').innerText = accepted;
            document.getElementById('rep-rej').innerText = rejected;
        }

        // --- 8. DASHBOARD & UTILS ---
        let charts = {};

        function updateDashboard() {
            // Stats
            document.getElementById('dash-total-nasabah').innerText = state.customers.length;
            
            if(state.decisions.length === 0) runScoring(); // Ensure data exists

            const layak = state.decisions.filter(d => !d.status.includes('TIDAK')).length;
            const tolak = state.decisions.length - layak;
            const avgLim = state.decisions.reduce((acc, curr) => acc + curr.limit, 0) / (state.decisions.length || 1);

            document.getElementById('dash-layak').innerText = layak;
            document.getElementById('dash-tolak').innerText = tolak;
            document.getElementById('dash-avg-limit').innerText = "Rp " + (avgLim/1000000).toFixed(1) + " Jt";

            // Chart 1: Status (Updated Colors: Red for Reject, Green for Accept)
            const ctx1 = document.getElementById('chartStatus').getContext('2d');
            if(charts.status) charts.status.destroy();
            charts.status = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Layak', 'Ditolak'],
                    datasets: [{
                        data: [layak, tolak],
                        backgroundColor: ['#10B981', '#DC2626']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Chart 2: AHP Weights (Updated Color: CIMB Red)
            const ctx2 = document.getElementById('chartAhp').getContext('2d');
            const labels = criteria.map(c => c.name);
            const data = criteria.map(c => state.ahpWeights[c.id] * 100);
            
            if(charts.ahp) charts.ahp.destroy();
            charts.ahp = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Bobot (%)',
                        data: data,
                        backgroundColor: '#B91C1C' // Red
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }

        function addLog(msg) {
           console.log(msg); // Only log to console
        }

        // Add Active State handler for nav (Simulated by click)
        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.addEventListener('click', function() {
                 document.querySelectorAll('.nav-item').forEach(b => {
                     b.classList.remove('bg-gray-800', 'border-l-4', 'border-red-600');
                 });
                 this.classList.add('bg-gray-800', 'border-l-4', 'border-red-600');
            });
        });

    </script>
</body>

</html>
